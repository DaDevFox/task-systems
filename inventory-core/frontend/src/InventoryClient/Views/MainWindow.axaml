<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:InventoryClient.ViewModels"
        xmlns:models="clr-namespace:InventoryClient.Models"
        xmlns:views="clr-namespace:InventoryClient.Views"
        xmlns:converters="clr-namespace:InventoryClient.Converters"
        xmlns:shared="clr-namespace:TaskSystems.Shared.Controls;assembly=TaskSystems.Shared"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="InventoryClient.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="Inventory Management System"
        WindowStartupLocation="CenterScreen">

  <Window.Styles>
    <Style Selector="Border.card">
      <Setter Property="Background" Value="#FFFFFF"/>
      <Setter Property="CornerRadius" Value="8"/>
      <Setter Property="Padding" Value="16"/>
      <Setter Property="Margin" Value="8"/>
      <Setter Property="BoxShadow" Value="0 2 8 0 #10000000"/>
    </Style>
    
    <Style Selector="TextBlock.header">
      <Setter Property="FontSize" Value="18"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="Margin" Value="0,0,0,12"/>
    </Style>
    
    <Style Selector="Button.primary">
      <Setter Property="Background" Value="#2563eb"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="Padding" Value="12,6"/>
      <Setter Property="CornerRadius" Value="4"/>
    </Style>
    
    <!-- Enhanced CheckBox styles for low stock filter -->
    <Style Selector="CheckBox.filter-checkbox">
      <Setter Property="Padding" Value="8"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="Foreground" Value="#64748b"/>
    </Style>
    
    <Style Selector="CheckBox.filter-checkbox:checked">
      <Setter Property="Background" Value="#fef3c7"/>
      <Setter Property="Foreground" Value="#d97706"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
    </Style>
  </Window.Styles>

  <Grid RowDefinitions="Auto,*">
    
    <!-- Header Section -->
    <Border Grid.Row="0" Background="#f8fafc" Padding="16">
      <Grid ColumnDefinitions="*,Auto">
        
        <!-- Title and Connection Status -->
        <StackPanel Grid.Column="0" Orientation="Vertical">
          <TextBlock Text="Inventory Management System" 
                     FontSize="24" FontWeight="Bold" 
                     Foreground="#1e293b"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <shared:StatusIndicator Status="{Binding ConnectionStatus}" 
                                    Description="{Binding ConnectionStatus}"/>
            <TextBlock Text="{Binding ServerAddress, StringFormat='Connected to: {0}'}" 
                       Foreground="#64748b" FontSize="12"
                       IsVisible="{Binding IsConnected}"/>
          </StackPanel>
        </StackPanel>
        
        <!-- Connection Controls -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
          <TextBox Text="{Binding ServerAddress}" 
                   Watermark="Server address (e.g., localhost:5000)"
                   Width="200"/>
          <Button Content="Connect" 
                  Command="{Binding ConnectCommand}"
                  Classes="primary"
                  IsEnabled="{Binding !IsConnected}"/>
          <Button Content="Disconnect" 
                  Command="{Binding DisconnectCommand}"
                  IsEnabled="{Binding IsConnected}"/>
          <Button Content="Refresh" 
                  Command="{Binding RefreshCommand}"
                  IsEnabled="{Binding IsConnected}"/>
        </StackPanel>
        
      </Grid>
    </Border>

    <!-- Main Content -->
    <Grid Grid.Row="1" ColumnDefinitions="300,*" IsEnabled="{Binding IsConnected}">
      
      <!-- Sidebar with Summary -->
      <Border Grid.Column="0" Classes="card" Margin="8,0,4,8">
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
          <StackPanel Spacing="16">
            
            <!-- Inventory Summary -->
            <TextBlock Text="Inventory Summary" Classes="header"/>
            <Border Classes="info-box" Padding="16">
              <StackPanel Spacing="8">
                <Grid ColumnDefinitions="*,Auto">
                  <TextBlock Text="Total Items:" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="1" Text="{Binding InventoryItems.Count}"/>
                </Grid>
                <Grid ColumnDefinitions="*,Auto">
                  <TextBlock Text="Low Stock:" FontWeight="SemiBold" Foreground="#d97706"/>
                  <TextBlock Grid.Column="1" Text="{Binding LowStockCount}" Foreground="#d97706"/>
                </Grid>
                <Grid ColumnDefinitions="*,Auto">
                  <TextBlock Text="Out of Stock:" FontWeight="SemiBold" Foreground="#dc2626"/>
                  <TextBlock Grid.Column="1" Text="{Binding EmptyItemsCount}" Foreground="#dc2626"/>
                </Grid>
                <Grid ColumnDefinitions="*,Auto">
                  <TextBlock Text="Total Items:" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="1" Text="{Binding TotalItems}"/>
                </Grid>
              </StackPanel>
            </Border>

            <!-- Filters -->
            <Separator Margin="0,8"/>
            <TextBlock Text="Filters" Classes="header"/>
            <StackPanel Spacing="8">
              <CheckBox Content="Show Low Stock Only" 
                        IsChecked="{Binding ShowLowStockOnly}"
                        Classes="filter-checkbox"/>
            </StackPanel>

            <!-- Chart Settings -->
            <Separator Margin="0,8"/>
            <TextBlock Text="Chart Settings" Classes="header"/>

            <!-- Chart Data Mode -->
            <TextBlock Text="Data Mode:" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,4"/>
            <ComboBox ItemsSource="{x:Static vm:MainViewModel.ChartDataModeOptions}"
                      SelectedItem="{Binding ChartDataMode}"
                      HorizontalAlignment="Stretch"/>

            <!-- Granularity (when using Granularity mode) -->
            <TextBlock Text="Granularity:" FontSize="12" FontWeight="SemiBold" Margin="0,8,0,4"
                       IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=Granularity}"/>
            <ComboBox ItemsSource="{x:Static vm:MainViewModel.ChartGranularityOptions}"
                      SelectedItem="{Binding ChartGranularity}"
                      HorizontalAlignment="Stretch"
                      IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=Granularity}"/>

            <!-- Max Points (when using Granularity mode) -->
            <TextBlock Text="Max Points:" FontSize="12" FontWeight="SemiBold" Margin="0,8,0,4"
                       IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=Granularity}"/>
            <NumericUpDown Value="{Binding ChartMaxPoints}" 
                           Minimum="10" Maximum="1000" Increment="10"
                           HorizontalAlignment="Stretch"
                           IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=Granularity}"/>

            <!-- Time Range Days (when using TimeRange mode) -->
            <TextBlock Text="Time Range (days):" FontSize="12" FontWeight="SemiBold" Margin="0,8,0,4"
                       IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=TimeRange}"/>
            <NumericUpDown Value="{Binding ChartTimeRangeDays}" 
                           Minimum="1" Maximum="365" Increment="1"
                           HorizontalAlignment="Stretch"
                           IsVisible="{Binding ChartDataMode, Converter={x:Static converters:EnumToBoolConverter.Instance}, ConverterParameter=TimeRange}"/>

            <!-- Show Predictions -->
            <CheckBox Content="Show Predictions" 
                      IsChecked="{Binding ShowChartPredictions}"
                      Classes="filter-checkbox"
                      Margin="0,8,0,0"/>

            <!-- Prediction Days (when showing predictions) -->
            <TextBlock Text="Prediction Days:" FontSize="12" FontWeight="SemiBold" Margin="0,8,0,4"
                       IsVisible="{Binding ShowChartPredictions}"/>
            <NumericUpDown Value="{Binding ChartPredictionDaysAhead}" 
                           Minimum="1" Maximum="30" Increment="1"
                           HorizontalAlignment="Stretch"
                           IsVisible="{Binding ShowChartPredictions}"/>

            <!-- Refresh Charts Button -->
            <Button Content="ðŸ”„ Refresh Charts" 
                    Command="{Binding RefreshChartsCommand}"
                    Classes="primary"
                    HorizontalAlignment="Stretch"
                    Margin="0,8,0,0"/>

            <!-- Quick Actions -->
            <Separator Margin="0,16,0,8"/>
            <TextBlock Text="Quick Actions" Classes="header"/>
            <Button Content="Open Log" 
                    Command="{Binding OpenDebugLogCommand}"
                    Classes="primary"
                    HorizontalAlignment="Stretch"/>

            <Button Content="Add Item" 
                    Command="{Binding AddItemCommand}"
                    Classes="primary"
                    HorizontalAlignment="Stretch"
                    Margin="0,4"/>

          </StackPanel>
        </ScrollViewer>
      </Border>
      
      <!-- Main Content Area -->
      <Grid Grid.Column="1" RowDefinitions="*,Auto" Margin="4,0,8,8">

        <!-- Chart Overlay -->
        <Border Grid.Row="0" 
                Background="#E0FFFFFF"
                IsVisible="{Binding IsChartVisible}"
                ZIndex="100">
          <Grid>
            <!-- DIRECT TEST: Skip ContentPresenter and bind directly to InventoryLevelChartView -->
            <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MaxWidth="800"
                    MaxHeight="600">
              <views:InventoryLevelChartView DataContext="{Binding SelectedItemChart}"/>
            </Border>
            
            <!-- Close Chart Button -->
            <Button Content="âœ•" 
                    Command="{Binding CloseChartCommand}"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="20"
                    Width="32" Height="32"
                    Background="#80FFFFFF"
                    FontSize="18"/>
          </Grid>
        </Border>

        <!-- Add Item Dialog Overlay -->
        <Border Grid.Row="0" 
                Background="#F0000000"
                IsVisible="{Binding IsAddItemDialogVisible}"
                ZIndex="101"
                Focusable="True">
          <Border.KeyBindings>
            <KeyBinding Gesture="Escape" Command="{Binding CloseAddItemDialogCommand}"/>
          </Border.KeyBindings>
          <Grid>
            <views:AddItemDialog DataContext="{Binding AddItemDialog}"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>
            
            <!-- Close Add Item Dialog Button -->
            <Button Content="âœ•" 
                    Command="{Binding CloseAddItemDialogCommand}"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="20"
                    Width="32" Height="32"
                    Background="#80FFFFFF"
                    FontSize="18"/>
          </Grid>
        </Border>
        
        <TabControl Grid.Row="0">
        
          <!-- Inventory Items Tab -->
          <TabItem Header="Inventory Items">
            <Grid RowDefinitions="Auto,*">
              
              <!-- Toolbar -->
              <Border Grid.Row="0" Background="#f8fafc" Padding="16,12">
                <Grid ColumnDefinitions="*,Auto">
                  <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <TextBlock Text="Inventory Items" FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding FilteredItems.Count, StringFormat='Showing {0} items'}" 
                               FontSize="12" Foreground="#64748b" VerticalAlignment="Center"/>
                    <TextBlock Text="(Low Stock Only)" 
                               FontSize="12" Foreground="#d97706" FontWeight="SemiBold" VerticalAlignment="Center"
                               IsVisible="{Binding ShowLowStockOnly}"/>
                  </StackPanel>
                  <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Add Item" Classes="primary"
                            Command="{Binding AddItemCommand}"/>
                    <Button Content="Update Level" 
                            Command="{Binding UpdateInventoryLevelCommand}"
                            CommandParameter="{Binding SelectedItem}"/>
                  </StackPanel>
                </Grid>
              </Border>
              
              <!-- Items DataGrid -->
              <Border Grid.Row="1" Classes="card" Margin="0,8,0,0">
                <ScrollViewer>
                  <DataGrid ItemsSource="{Binding FilteredItems}"
                            SelectedItem="{Binding SelectedItem}"
                            AutoGenerateColumns="False"
                            GridLinesVisibility="Horizontal"
                            HeadersVisibility="Column"
                            Background="Transparent"
                            RowBackground="Transparent">
                    
                    <DataGrid.Columns>
                      
                      <DataGridTextColumn Header="Name" 
                                          Binding="{Binding Name}" 
                                          Width="*" MinWidth="120"/>
                      
                      <DataGridTextColumn Header="Description" 
                                          Binding="{Binding Description}" 
                                          Width="*" MinWidth="150"/>
                      
                      <DataGridTextColumn Header="Current Level" 
                                          Width="120">
                        <DataGridTextColumn.Binding>
                          <MultiBinding StringFormat="{}{0:F1} {1}">
                            <Binding Path="CurrentLevel"/>
                            <Binding Path="UnitId"/>
                          </MultiBinding>
                        </DataGridTextColumn.Binding>
                      </DataGridTextColumn>
                      
                      <DataGridTemplateColumn Header="Capacity" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                          <DataTemplate>
                            <StackPanel Orientation="Vertical" Spacing="2">
                              <TextBlock Text="{Binding CurrentLevelPercentage, StringFormat='{}{0:F1}%'}" 
                                         FontWeight="SemiBold"/>
                              <ProgressBar Value="{Binding CurrentLevelPercentage}" 
                                           Maximum="100" Height="8"/>
                            </StackPanel>
                          </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                      </DataGridTemplateColumn>
                      
                      <DataGridTemplateColumn Header="Status" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                          <DataTemplate>
                            <shared:StatusIndicator Status="{Binding StockStatus}" 
                                                    Description="{Binding StockStatus}"/>
                          </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                      </DataGridTemplateColumn>
                      
                      <DataGridTextColumn Header="Days Remaining" 
                                          Binding="{Binding PredictedDaysRemaining, StringFormat='{}{0:F1} days'}" 
                                          Width="120"/>
                      
                      <DataGridTextColumn Header="Last Updated" 
                                          Binding="{Binding LastUpdated, StringFormat='{}{0:MM/dd HH:mm}'}" 
                                          Width="120"/>
                      
                      <DataGridTemplateColumn Header="Actions" Width="160">
                        <DataGridTemplateColumn.CellTemplate>
                          <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                              <Button Content="ðŸ“Š" 
                                      Command="{Binding $parent[DataGrid].((vm:MainViewModel)DataContext).ShowItemChartCommand}"
                                      CommandParameter="{Binding}"
                                      Width="28" Height="28"
                                      FontSize="12"
                                      ToolTip.Tip="Show Chart"/>
                              <Button Content="ðŸ“" 
                                      Command="{Binding $parent[DataGrid].((vm:MainViewModel)DataContext).UpdateInventoryLevelCommand}"
                                      CommandParameter="{Binding}"
                                      Width="28" Height="28"
                                      FontSize="12"
                                      ToolTip.Tip="Update Level"/>
                              <Button Content="ðŸ—‘ï¸" 
                                      Command="{Binding $parent[DataGrid].((vm:MainViewModel)DataContext).RemoveItemCommand}"
                                      CommandParameter="{Binding}"
                                      Width="28" Height="28"
                                      FontSize="12"
                                      ToolTip.Tip="Remove Item"
                                      Background="#dc2626"
                                      Foreground="White"/>
                            </StackPanel>
                          </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                      </DataGridTemplateColumn>
                      
                    </DataGrid.Columns>
                    
                  </DataGrid>
                </ScrollViewer>
              </Border>
            </Grid>
          </TabItem>
          
          <!-- Item Cards View Tab -->
          <TabItem Header="Item Cards">
            <Grid RowDefinitions="Auto,*">
              
              <!-- Toolbar -->
              <Border Grid.Row="0" Background="#f8fafc" Padding="16,12">
                <Grid ColumnDefinitions="*,Auto">
                  <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <TextBlock Text="Item Overview" FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding DisplayedItems.Count, StringFormat='Showing {0} items'}" 
                               FontSize="12" Foreground="#64748b" VerticalAlignment="Center"/>
                    <TextBlock Text="(Low Stock Only)" 
                               FontSize="12" Foreground="#d97706" FontWeight="SemiBold" VerticalAlignment="Center"
                               IsVisible="{Binding ShowLowStockOnly}"/>
                  </StackPanel>
                  <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="ðŸ“¦ Add Item" Classes="primary" Command="{Binding AddItemCommand}"/>
                    <Button Content="ðŸ“ Report Level" Command="{Binding ReportInventoryLevelCommand}"/>
                  </StackPanel>
                </Grid>
              </Border>
              
              <!-- Items Cards -->
              <ScrollViewer Grid.Row="1" Margin="8">
                <ItemsControl ItemsSource="{Binding DisplayedItems}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <views:InventoryItemCard/>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </Grid>
          </TabItem>

        <!-- Prediction Tab -->
        <TabItem Header="Prediction">
          <Grid RowDefinitions="Auto,*">

            <!-- Toolbar -->
            <Border Grid.Row="0" Background="#f8fafc" Padding="16,12">
              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Grid.Column="0"
                           Text="Inventory Level Chart" 
                           FontSize="18" FontWeight="SemiBold" 
                           VerticalAlignment="Center"
                           Margin="0,0,16,0"/>
                           
                <!-- Item Selection ComboBox -->
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding InventoryItems}"
                          SelectedItem="{Binding SelectedPredictionItem}"
                          PlaceholderText="Select item for prediction..."
                          DisplayMemberBinding="{Binding Name}"
                          MinWidth="250"
                          HorizontalAlignment="Left"/>
              </Grid>
            </Border>

            <!-- Prediction Content -->
            <Border Grid.Row="1" Classes="card" Margin="0,8,0,0">
              <Grid>
                <!-- DIRECT TEST: Skip ContentPresenter and bind directly to InventoryLevelChartView -->
                <views:InventoryLevelChartView DataContext="{Binding StaticPredictionChart}"/>
              </Grid>
            </Border>
          </Grid>
        </TabItem>
        
        </TabControl>
        
      </Grid>
      
    </Grid>
    
    <!-- Loading Overlay -->
    <Border Grid.RowSpan="2" 
            Background="#80000000" 
            IsVisible="{Binding IsLoading}">
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
        <TextBlock Text="âŸ³" FontSize="48" HorizontalAlignment="Center" 
                   Foreground="White" Classes="spinning"/>
        <TextBlock Text="Loading..." FontSize="18" Foreground="White" HorizontalAlignment="Center"/>
      </StackPanel>
    </Border>
    
    <!-- Error Display -->
    <Border Grid.RowSpan="2" 
            Background="#dc2626" 
            Padding="16,8"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Bottom"
            IsVisible="{Binding HasConnectionError}">
      <Grid ColumnDefinitions="*,Auto">
        <TextBlock Grid.Column="0" Text="{Binding ConnectionError}" 
                   Foreground="White" VerticalAlignment="Center"/>
        <Button Grid.Column="1" Content="âœ•" 
                Command="{Binding ClearConnectionErrorCommand}"
                Background="Transparent" Foreground="White"
                Padding="8,4"/>
      </Grid>
    </Border>
    
  </Grid>
  
</Window>
